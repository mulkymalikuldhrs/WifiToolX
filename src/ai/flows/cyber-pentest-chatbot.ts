
'use server';

/**
 * @fileOverview A Cyber Pentesting Chatbot AI agent.
 *
 * - cyberPentestChatbot - A function that handles the chatbot interaction.
 */

import {ai} from '@/ai/genkit';
import {
  CyberPentestChatbotInputSchema,
  CyberPentestChatbotOutputSchema,
  type CyberPentestChatbotInput,
  type CyberPentestChatbotOutput,
  ChatMessageSchema,
} from '@/lib/types';
import {z} from 'zod';


export async function cyberPentestChatbot(
  input: CyberPentestChatbotInput
): Promise<CyberPentestChatbotOutput> {
  return cyberPentestChatbotFlow(input);
}

const CyberPentestChatbotPromptInputSchema = z.object({
  history: z.array(z.object({
    isUser: z.boolean(),
    content: z.string(),
  })).describe("The conversation history."),
  message: z.string().describe('The latest message from the user.'),
});

const prompt = ai.definePrompt({
  name: 'cyberPentestChatbotPrompt',
  input: {schema: CyberPentestChatbotPromptInputSchema},
  output: {schema: CyberPentestChatbotOutputSchema},
  prompt: `You are a helpful and highly knowledgeable Cyber Pentest AI Assistant integrated into a tool called WiFiHunterX. Your role is to assist users with their penetration testing queries.

  You should be able to:
  - Explain cybersecurity concepts clearly.
  - Provide examples of commands for various tools (e.g., nmap, aircrack-ng, hashcat, metasploit).
  - Suggest methodologies for different types of penetration tests.
  - Answer questions about vulnerabilities and exploits.

  When providing commands, always add a disclaimer that they should only be used on networks and systems for which the user has explicit, written permission to test. Do not provide instructions for illegal or unethical activities.

  Here is the conversation history:
  {{#each history}}
    {{#if isUser}}
      User: {{{content}}}
    {{else}}
      Model: {{{content}}}
    {{/if}}
  {{/each}}

  User's new message: {{{message}}}

  Provide a direct, helpful, and concise response to the user's latest message.
`,
});

const cyberPentestChatbotFlow = ai.defineFlow(
  {
    name: 'cyberPentestChatbotFlow',
    inputSchema: CyberPentestChatbotInputSchema,
    outputSchema: CyberPentestChatbotOutputSchema,
  },
  async input => {
    // Pre-process the history to add the 'isUser' boolean flag for the template
    const processedHistory = input.history.map(msg => ({
        isUser: msg.role === 'user',
        content: msg.content
    }));
    
    const {output} = await prompt({
        history: processedHistory,
        message: input.message
    });

    return output!;
  }
);
